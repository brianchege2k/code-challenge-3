<html>
  <head>
    <meta charset="UTF-8" />
    <title>Code Challenge</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"
    />
    <link rel="stylesheet" href="assets/index.css" />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  </head>
  <body>
    <!-- navbar -->
    <div class="heading">
      <div class="item">
        <h2 class="ui header">
          <i class="orange ticket icon"></i>
          <div class="content">FLATDANGO</div>
          <div class="sub header" id="subtitle">BUY MOVIE TICKETS</div>
        </h2>
      </div>
    </div>

    <div class="ui centered grid">
      <div class="four wide column">
        <div class="list-container">
          <!-- side menu -->
          <ul class="ui divided list" id="films">
            <li class="film item">Movie titles will go here.</li>
          </ul>
        </div>
      </div>

      <!-- poster -->
      <div class="four wide column">
        <img
          id="poster"
          src="assets/placeholderImage.png"
          alt="[MOVIE TITLE]"
        />
      </div>

      <!-- showing info -->
      <div class="four wide column">
        <div class="ui cards" id="showing">
          <div class="card">
            <div id="title" class="title">[MOVIE TITLE]</div>
            <div id="runtime" class="meta">[RUNTIME] minutes</div>
            <div class="content">
              <div class="description">
                <div id="film-info">[INSERT MOVIE DESCRIPTION HERE]</div>
                <span id="showtime" class="ui label">[SHOWTIME]</span>
                <span id="ticket-num">[X]</span> remaining tickets
              </div>
            </div>
            <div class="extra content">
              <button id="buy-ticket" class="ui orange button">
                Buy Ticket
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Your code here
//apiURL
const apiURL = 'http://localhost:3000/films'
//fetch the data from server
fetch(apiURL,{
    method: 'GET',
    headers:{
        'Content-Type': 'application/json'
    }
})
//conversion to json format
.then((response) => response.json())
.then((data) => {

//loading the titles in the list
    const allMovieTitles = document.querySelector('#films')
    allMovieTitles.innerHTML = ''
    data.forEach((title, index)=> {
        const movieTitlesList = document.createElement('li')
        movieTitlesList.innerText = title.title
        //deleteFilm button
        const deleteFilm = document.createElement('button')
        deleteFilm.innerText =  'Delete'
        deleteFilm.addEventListener('click', () =>{
          deleteTitle(title.id) //deletes from server
          movieTitlesList.remove() //remove from html list
        })
        movieTitlesList.append(deleteFilm)

        //add an eventlistener for when a particular title is selected, the showTitleInfo function is called
        movieTitlesList.addEventListener('click', () =>{
          showTitleInfo(title)
        })
        // finally append the titles to the list
        allMovieTitles.append(movieTitlesList)
        //display the first film when page is loaded
        if(index === 0){
          showTitleInfo(title)
        }
    });
})
//function to display the movies
function showTitleInfo(title){
  //selection of various id's in the HTML
  document.querySelector('#title').innerText = title.title
  document.querySelector('#runtime').innerText = title.runtime
  document.querySelector('#film-info').innerText = title.description
  document.querySelector('#showtime').innerText = title.showtime
  document.querySelector('#ticket-num').innerText = `${title.capacity - title.tickets_sold}`
  document.querySelector('#poster').src = title.poster
}

//Buy Tickets Button, event listner used for when the button is clicked
document.querySelector("#buy-ticket").addEventListener('click', () => {
  //Get the current tickets and store in a variable
  const allAvailableTickets = document.querySelector('#ticket-num')
  let availableTickets = parseInt(allAvailableTickets.textContent)
//reduce by one ticket
  if(!isNaN(availableTickets) && availableTickets > 0){
    availableTickets --;
    //update the element
    allAvailableTickets.innerText = availableTickets;

  }
  if (availableTickets === 0){
    document.querySelector('#buy-ticket').innerText = 'Sold Out'
  }

})
//delete Title from server function 
function deleteTitle(id){
  fetch(`${apiURL}/${id}`, {
    method:'DELETE'
  })
  .then(resp => {
    if(resp.ok){
      alert('Title Deleted Successfullly.');
    }else{
      alert('Error deleting Title')
    }
  })
}
  




    </script>
  </body>
</html>
